<?phpdeclare(strict_types=1);namespace App\AdminModule\Forms\Products;use DbTable;use Nette\Database;use Nette\Application\UI\Form;use Nette\Security\User;/** * Formular a jeho spracovanie pre pridanie viacerich produktov polozky. * Posledna zmena 09.07.2020 *  * @author     Ing. Peter VOJTECH ml. <petak23@gmail.com> * @copyright  Copyright (c) 2012 - 2020 Ing. Peter VOJTECH ml. * @license * @link       http://petak23.echo-msz.eu * @version    1.0.6 */class AddMultiProductsFormFactory {    /** @var DbTable\Products */	private $products;  /** @var array */  private $products_settings;  /** @var int */  private $id_user_main;  /** @var string */  private $wwwDir;  /** @var string */  private $products_dir;    /**   * @param DbTable\Products $products   * @param DbTable\Udaje $udaje   * @param User $user   * @param string $wwwDir */  public function __construct(DbTable\Products $products, DbTable\Udaje $udaje, User $user, string $wwwDir = "") {    $this->products = $products;    $this->products_settings = $udaje->findBy(['id_druh'=>8])->fetchPairs('nazov', 'text');    $this->id_user_main = $user->getId();    $this->wwwDir = $wwwDir;	}    /**   * Formular pre pridanie produktu a editaciu polozky.   * @param string $products_dir Adresar pre ulozenie obrazkov produktov   * @param string $www_dir www Adresar webu   * @param \Nette\Database\Table\ActiveRow $clanok Clanok, ku ktoremu su produkty    * @return Form */  public function create(string $products_dir, string $www_dir, Database\Table\ActiveRow $clanok): Form  {    $this->products->setWwwDir($www_dir);    $this->products_dir = $products_dir;    $form = new Form();		$form->addProtection();    $form->addSubmit('ulozz', 'Ukonč')         ->setAttribute('class', 'btn btn-success')         ->onClick[] = [$this, 'productsFormSubmitted'];    $form->addFileUpload("uploader")         ->setMaxFiles((int)$this->products_settings["product_max_upload_files"])         ->setFileFilter('\Zet\FileUpload\Filter\ImageFilter')         ->setParams(['products_dir' =>$products_dir,                      'products_settings' => $this->products_settings,                      'main_data' => [                           'id_hlavne_menu'	 	=> $clanok->id_hlavne_menu,                          'id_user_main'      => $this->id_user_main,                          'id_user_roles'     => $clanok->hlavne_menu->id_user_roles,                        ]                     ])         ->setOption('description',                  sprintf('Max veľkosť obrázku produktu určená serverom je: %s. Maximálny počet nahrávaných obrázkov je %s.',                          $form['uploader']->getFileSizeString(),                          $form['uploader']->getMaxFiles()                        )                );		$form->addSubmit('ulozk', 'Ukonč')         ->setAttribute('class', 'btn btn-success')         ->onClick[] = [$this, 'productsFormSubmitted'];		return $form;	}    /**    * Spracovanie formulara.   * @param \Nette\Forms\Controls\SubmitButton $button Data formulara    * @throws Database\DriverException   */  public function productsFormSubmitted(\Nette\Forms\Controls\SubmitButton $button) {    $values = $button->getForm()->getValues(); 	//Nacitanie hodnot formulara    $uploader = $values->uploader;    if ($uploader != null) { // Presun suborov z tmp adresara      foreach ($uploader as $k=>$v) {        $prod = $this->products->find($v);        $image_name = str_replace('tmp/', "", $prod->main_file);        $thumb_name = str_replace('tmp/', "", $prod->thumb_file);        rename($prod->main_file, $image_name);        rename($prod->thumb_file, $thumb_name);        $prod->update([            "main_file" => $image_name,            "thumb_file" => $thumb_name,            "saved" => 1,        ]);      }    }    // Vymazanie tmp adresara ak tam nieco zostalo - napr. chybne prenosy    foreach (glob($this->products_dir."tmp/*", GLOB_NOSORT) as $file) {      @unlink($file);    }  }}